# CD Pipeline - Deploy to Kubernetes
# Runs after successful CI on main branch

name: CD Pipeline

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types: [completed]
    branches: [main]

env:
  KUBE_NAMESPACE: default

jobs:
  deploy-and-test:
    name: Deploy and Smoke Test (Kind)
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    permissions:
      contents: read
      packages: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Debug Info
        run: |
          echo "Current SHA: ${{ github.sha }}"
          echo "Workflow Run Head SHA: ${{ github.event.workflow_run.head_sha }}"
      
      - name: Lowercase Repo Name
        run: |
          echo "REPO_LC=${GITHUB_REPOSITORY,,}" >> $GITHUB_ENV

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull Docker image
        run: |
          docker pull ghcr.io/${{ env.REPO_LC }}:${{ github.event.workflow_run.head_sha }}
          docker tag ghcr.io/${{ env.REPO_LC }}:${{ github.event.workflow_run.head_sha }} catsdogs-classifier:latest

      - name: Create k8s Kind Cluster
        uses: helm/kind-action@v1.9.0
        with:
          cluster_name: kind

      - name: Load image into Kind
        run: |
          kind load docker-image catsdogs-classifier:latest --name kind

      - name: Update deployment image
        run: |
          # Use local image name since we loaded it into Kind
          sed -i "s|image:.*|image: catsdogs-classifier:latest|g" k8s/deployment.yaml
          # Set imagePullPolicy to Never or IfNotPresent to use the loaded image
          sed -i "s|imagePullPolicy:.*|imagePullPolicy: IfNotPresent|g" k8s/deployment.yaml || echo "imagePullPolicy not found, appending..."
          # If sed failed to find matches, we might need to be careful, but standard deployment usually doesn't have it explicitly set or has it. 
          # Let's just rely on the fact that if we use a specific tag, it should default to 'Always' if 'latest' or 'IfNotPresent' otherwise. 
          # Since we tagged it ':latest', k8s defaults to Always. We MUST set it to IfNotPresent or Never.
          # Let's ensure the spec has imagePullPolicy.
          sed -i "/image: catsdogs-classifier:latest/a \          imagePullPolicy: IfNotPresent" k8s/deployment.yaml

      - name: Deploy to Kubernetes
        run: |
          kubectl apply -f k8s/deployment.yaml
          kubectl apply -f k8s/service.yaml

      - name: Wait for rollout
        run: |
          kubectl rollout status deployment/catsdogs-classifier -n ${{ env.KUBE_NAMESPACE }} --timeout=300s

      - name: Get service info
        run: |
          kubectl get pods -n ${{ env.KUBE_NAMESPACE }} -l app=catsdogs-classifier
          kubectl get svc -n ${{ env.KUBE_NAMESPACE }} catsdogs-classifier-service

      - name: Setup Port Forward
        run: |
          # Background port forward
          kubectl port-forward svc/catsdogs-classifier-service 8000:80 &
          echo "Waiting for port-forward..."
          sleep 10

      - name: Run smoke tests
        run: |
          chmod +x scripts/smoke_test.sh
          # Just simply check health here for immediate verification
          curl -v http://localhost:8000/health
          SERVICE_URL=http://localhost:8000 ./scripts/smoke_test.sh

      - name: Debug on Failure
        if: failure()
        run: |
          kubectl describe pods
          kubectl logs -l app=catsdogs-classifier --tail=100
